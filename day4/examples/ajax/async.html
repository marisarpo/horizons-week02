<!DOCTYPE html>
<html >
  <head>
    <meta charset="UTF-8">
    <title>Horizons AJAX Async Example</title>
  </head>

  <body>

    <h1>AJAX Async Example</h1>

    <p>Use <a href="http://api.jquery.com/jquery.ajax/">$.ajax()</a> to fetch <a href="https://horizons-json-cors.s3.amazonaws.com/products.json">these products</a> in JavaScript on this page. Display their names and prices below as a bulleted list.</p>
    <p>
      The link above will respond with an array of urls. You need to asynchronously make AJAX requests to these links, and then sort the results in increasing price order (lowest price up top).
    </p>

    <div id="products">REPLACE me with the sorted list of products! My <code>id is "products"</code>.</div>

    <h2>Example output</h2>
    <ul>
      <li>Raspberry Pi, $33.53</li>
      <li>Amazon Echo, $179.99</li>
      <li>DJI Phantom 3, $416.59</li>
    </ul>

    <script src='https://code.jquery.com/jquery-2.2.4.min.js'></script>
    <script>
      // YOUR CODE HERE
      $.ajax({
        url: 'http://horizons-json-cors.s3.amazonaws.com/products.json',
        success: function(response){
          var urlArray = []; //for storing urls
          //loop through response object in [{obj},{obj},{obj}] format
          response.forEach(function(object){
            urlArray.push(object["url"]); //push each url to the url array
          });
          var objArray = []; //for storing price objects
          //loop through list of urls
          urlArray.forEach(function(link){
            // and retrieve data for each
            $.ajax({
              url: link,
              success: function(response2){
                //pushing each object to objArray
                objArray.push(response2);
                if (objArray.length === 3){
                  //sort the objects in objArray by price, lowest to highest
                  objArray.sort(function(currentObj, nextObj){
                    return nextObj["priceCents"] > currentObj["priceCents"];
                  });
                  //add to page one-by-one
                  var html = "<ul>";
                  for (var i = 0; i < objArray.length; i++){
                    console.log(objArray);
                    html += ("<li>" + (objArray[i]["name"]).toString() + ", " + objArray[i]["priceCents"] + "</li>");
                  }
                  html += "</ul>";
                  console.log(html);
                  $("#products").text(html);
                }
              }, error: function(e){
                console.log("Inner failed.");
                console.log(e.responseText);
              }
            });
          });
        }, error: function(e){
          console.log("Outer failed")
          console.log(e.responseText);
        }

      });
    </script>
  </body>
</html>

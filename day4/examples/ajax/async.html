<!DOCTYPE html>
<html >
  <head>
    <meta charset="UTF-8">
    <title>Horizons AJAX Async Example</title>
  </head>

  <body>

    <h1>AJAX Async Example</h1>

    <p>Use <a href="http://api.jquery.com/jquery.ajax/">$.ajax()</a> to fetch <a href="https://horizons-json-cors.s3.amazonaws.com/products.json">these products</a> in JavaScript on this page. Display their names and prices below as a bulleted list.</p>
    <p>
      The link above will respond with an array of urls. You need to asynchronously make AJAX requests to these links, and then sort the results in increasing price order (lowest price up top).
    </p>

    <div id="products">REPLACE me with the sorted list of products! My <code>id is "products"</code>.</div>

    <h2>Example output</h2>
    <ul>
      <li>Raspberry Pi, $33.53</li>
      <li>Amazon Echo, $179.99</li>
      <li>DJI Phantom 3, $416.59</li>
    </ul>

    <script src='https://code.jquery.com/jquery-2.2.4.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js'></script>
    <script>

      $.ajax({
        // url: $('a')[1].href,
        url: $('a')[1].href,
        success: function(resp){
          var results = [];

          // from an array map that results from returning ajax on link
          // when that array is done, run a function that
          // a) takes in all arguments which is an array of things,
          //    - the three things are
          //      i. JSON Object
          //      ii. a string stating whether ajax is success or error
          //      iii. jQuery/ajax stuff
          // b) use groupBy to get priceCents as a key, which automatically sorts
          // c) use mapObject to change values from array of things to a string
          //    containing name and priceCents surrounded by <li> tags
          // d) use Object.values() to get values formed from mapObject into Array
          //    and join these values with '' to form a big string
          // e) surround this big string of <li>s with <ul> tags
          // f) clear the text associated with the div having id = 'products'
          // g) append to div having id = 'products' this big <ul> string
          
          $.when.apply($, resp.map(function(link) {
            return $.ajax({url: link.url});
          })).done(function() {
            var args = Array.apply(null, arguments);
            var string = '<ul>'+Object.values(_.mapObject(_.groupBy(args,
              function(obj){
                return obj[0].priceCents;
              }),
              function(arr,price){
                return `<li>${arr[0][0].name}, $${price/100}</li>`;
              })).join('')+'</ul>';
            $('#products').text("");
            $('#products').append($(string));
          })
        }
      })

    </script>
  </body>
</html>
